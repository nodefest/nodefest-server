<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title></title>
</head>
<body>

<div id="out">
  <svg width="418" height="251"></svg>
</div>


<script src="./browserMqtt.js"></script>
<script src="./rhino-paintoon.js"></script>
<script src="./snap.svg-min.js"></script>
<script>

'use strict';

var rhino = {
frame: 2,
shapes: [
{
  fill:"#726853",
  path:[
    "M198.5,176.852295 L235.8,250.699401 L199.45,250.549102 L198.5,176.852295 Z",
    "M198.5,176.852295 L235.8,250.699401 L199.45,250.549102 L198.5,176.852295 Z"
  ],
},
{
  fill:"#A39C8C",
  path:[
    "M387.9,23.2964072 L389.85,118.285629 L413.3,130.61018 L387.9,23.2964072 Z",
    "M410.4,11.4l-20.5,106.9l23.5,12.3L410.4,11.4z"
  ],
},
{
  fill:"#9A907F",
  path:[
    "M113.3,0.300598802 L45.2,23.2964072 L100.8,66.4824351 L113.3,0.300598802 Z",
    "M113.3,0.3l-68.1,23l55.6,43.2L113.3,0.3z"
  ],
},
{
  fill:"#645A4A",
  path:[
    "M69.5,225.549301 L73.35,172.343313 L42.4,179.357285 L69.5,225.549301 Z",
    "M69.5,225.5l3.9-53.2l-31,7L69.5,225.5z"
  ],
},
{
  fill:"#BAAD9E",
  path:[
    "M159.2,8.66726547 L113.3,0.300598802 L126.65,52.8552894 L159.2,8.66726547 Z",
    "M159.2,8.7l-45.9-8.4l13.4,52.6L159.2,8.7z"
  ],
},
{
  fill:"#837C6C",
  path:[
    "M45.2,23.2964072 L23.65,114.528144 L100.8,66.4824351 L45.2,23.2964072 Z",
    "M45.2,23.3l-21.6,91.2l77.1-48L45.2,23.3z"
  ],
},
{
  fill:"#50473A",
  path:[
    "M23.65,114.528144 L42.4,179.357285 L73.35,172.343313 L100.8,66.4824351 L23.65,114.528144 Z",
    "M23.6,114.5l18.8,64.8l31-7l27.4-105.9L23.6,114.5z"
  ],
},
{
  fill:"#3F3723",
  path:[
    "M221.6,222.793812 L198.05,181.561677 L230.15,179.357285 L221.6,222.793812 Z",
    "M221.6,222.8L198,181.6l32.1-2.2L221.6,222.8z"
  ],
},
{
  fill:"#645A4A",
  path:[
    "M254.85,243.38483 L286.4,171.291218 L249.05,171.541717 L254.85,243.38483 Z",
    "M270.4,242.6l16-71.3l-37.4,0.2L270.4,242.6z"
  ],
},
{
  fill:"#827865",
  path:[
    "M261.4,102.003194 L286.4,171.291218 L326.6,112.373852 L261.4,102.003194 Z",
    "M261.4,102l25,69.3l40.2-58.9L261.4,102z"
  ],
},
{
  fill:"#9F9787",
  path:[
    "M326.6,112.373852 L326.6,112.373852 L333.7,166.782236 L352.45,74.3481038 L326.6,112.373852 Z",
    "M326.6,112.4L326.6,112.4l7.1,54.4l18.8-92.4L326.6,112.4z"
  ],
},
{
  fill:"#50473A",
  path:[
    "M249.05,171.541717 L286.4,171.291218 L261.4,102.003194 L249.05,171.541717 Z",
    "M249,171.5l37.4-0.2l-25-69.3L249,171.5z"
  ],
},
{
  fill:"#8F8776",
  path:[
    "M381.45,125.5 L333.7,166.782236 L417.8,171.341317 L381.45,125.5 Z",
    "M381.5,125.5l-47.8,41.3l84.1,4.6L381.5,125.5z"
  ],
},
{
  fill:"#382C23",
  path:[
    "M198.85,182.212974 L229.75,180.008583 L249.05,171.541717 L261.4,102.003194 L198.85,182.212974 Z",
    "M198.9,182.2l30.9-2.2l19.3-8.5l12.4-69.5L198.9,182.2z"
  ],
},
{
  fill:"#B6AD9E",
  path:[
    "M365.7,105.560279 L333.7,166.782236 L381.45,125.5 L365.7,105.560279 Z",
    "M365.7,105.6l-32,61.2l47.8-41.3L365.7,105.6z"
  ],
},
{
  fill:"#8F8776",
  path:[
    "M326.6,112.373852 L286.4,171.291218 L333.7,166.782236 L326.6,112.373852 L326.6,112.373852 Z",
    "M326.6,112.4l-40.2,58.9l47.3-4.5L326.6,112.4L326.6,112.4z"
  ],
},
{
  fill:"#827865",
  path:[
    "M308.65,195.339122 L333.7,166.782236 L286.4,171.291218 L308.65,195.339122 Z",
    "M308.7,195.3l25-28.6l-47.3,4.5L308.7,195.3z"
  ],
},
{
  fill:"#3F3723",
  path:[
    "M286.4,242.483034 L276.05,193.936327 L254.8,242.483034 L286.4,242.483034 Z",
    "M303.5,242l-21.2-50l-10.4,50H303.5z"
  ],
},
{
  fill:"#BBAF9F",
  path:[
    "M308.65,61.3221557 L285.05,37.9255489 L226.65,0.300598802 L261.4,102.003194 L308.65,61.3221557 Z",
    "M308.7,61.3L285,37.9L226.7,0.3L261.4,102L308.7,61.3z"
  ],
},
{
  fill:"#9F9787",
  path:[
    "M326.6,112.373852 L326.6,112.373852 L308.65,61.3221557 L261.4,102.003194 L326.6,112.373852 Z",
    "M326.6,112.4L326.6,112.4l-17.9-51.1L261.4,102L326.6,112.4"
  ],
},
{
  fill:"#6C634D",
  path:[
    "M322.2,33.5668663 L310.8,64.4784431 L337.85,70.29002 L322.2,33.5668663 Z",
    "M322.2,33.6l-11.4,30.9l27,5.8L322.2,33.6z"
  ],
},
{
  fill:"#9A907F",
  path:[
    "M348.75,40.0798403 L327.55,67.2339321 L346,72.3942116 L348.75,40.0798403 Z",
    "M348.8,40.1l-21.2,27.2l18.5,5.2L348.8,40.1z"
  ],
},
{
  fill:"#51483B",
  path:[
    "M114,237.473054 L117.65,184.818164 L130,179.707984 L137.65,213.124551 L143.35,238.174451",
    "M114,237.5l3.6-52.7l12.4-5.1l7.6,33.4l5.7,25"
  ],
},
{
  fill:"#382C23",
  path:[
    "M130,180.70998 L94.9,171.541717 L114,237.473054",
    "M130,180.7l-35.1-9.2l19.1,65.9"
  ],
},
{
  fill:"#726853",
  path:[
    "M42.45,179.407385 L34.05,244.487026 L81.7,244.487026 L42.45,179.407385 Z",
    "M42.5,179.4L34,244.5h47.7L42.5,179.4z"
  ],
},
{
  fill:"#3F3723",
  path:[
    "M35.1,67.6347305 L0.35,163.976647 L24.7,114.528144",
    "M35.1,67.6L0.4,164l24.4-49.4"
  ],
},
{
  fill:"#645A4A",
  path:[
    "M73,172.343313 L95.75,172.794212 L130,180.76008 L100.75,66.4323353 L73,172.343313 Z",
    "M73,172.3l22.8,0.5l34.2,8L100.8,66.4L73,172.3z"
  ],
},
{
  fill:"#9A907F",
  path:[
    "M130,180.76008 L198.85,182.212974 L100.8,66.4824351 L130,180.76008 Z",
    "M130,180.8l68.9,1.5L100.8,66.5L130,180.8z"
  ],
},
{
  fill:"#C1B6A9",
  path:[
    "M352.45,74.3481038 L333.7,68.9373253 L308.65,61.3221557 L326.6,112.373852 L352.45,74.3481038 Z",
    "M352.5,74.3l-18.8-5.4l-25-7.6l17.9,51.1L352.5,74.3z"
  ],
},
{
  fill:"#827865",
  path:[
    "M261.4,102.003194 L226.65,0.300598802 L207.8,118.285629 L261.4,102.003194 Z",
    "M261.4,102L226.7,0.3l-18.9,118L261.4,102z"
  ],
},
{
  fill:"#9F9787",
  path:[
    "M226.65,0.300598802 L100.8,66.4824351 L207.8,118.285629 L226.65,0.300598802 Z",
    "M226.7,0.3L100.8,66.5l107,51.8L226.7,0.3z"
  ],
},
{
  fill:"#645A4A",
  path:[
    "M207.8,118.285629 L198.85,182.212974 L261.4,102.003194 L207.8,118.285629 Z",
    "M207.8,118.3l-8.9,63.9l62.6-80.2L207.8,118.3z"
  ],
},
{
  fill:"#6C634D",
  path:[
    "M100.8,66.4824351 L198.85,182.212974 L207.8,118.285629 L100.8,66.4824351 Z",
    "M100.8,66.5l98.1,115.7l8.9-63.9L100.8,66.5z"
  ],
},
{
  fill:"#B6AD9E",
  path:[
    "M352.45,74.3481038 L343.55,118.285629 L343.1,120.59022 L365.7,105.560279 L352.45,74.3481038 Z",
    "M352.5,74.3l-8.9,43.9l-0.5,2.3l22.6-15L352.5,74.3z"
  ],
},
{
  fill:"#827865",
  path:[
    "M365.7,105.560279 L343.1,120.59022 L333.7,166.782236 L365.7,105.560279 Z",
    "M365.7,105.6l-22.6,15l-9.4,46.2L365.7,105.6z"
  ],
},
{
  fill:"#837C6C",
  path:[
    "M113.3,0.300598802 L100.8,66.4824351 L126.65,52.8552894 L113.3,0.300598802 Z",
    "M113.3,0.3l-12.5,66.2l25.9-13.6L113.3,0.3z"
  ],
},
{
  fill:"#837C6C",
  path:[
    "M159.2,8.66726547 L226.65,0.300598802 L126.65,52.8552894 L159.2,8.66726547 Z",
    "M159.2,8.7l67.5-8.4l-100,52.6L159.2,8.7z"
  ],
},
{
  fill:"#827865",
  path:[
    "M365.7,105.560279 L417.8,171.341317 L413.3,130.61018 L365.7,105.560279 Z",
    "M365.7,105.560279 L417.8,171.341317 L413.3,130.61018 L365.7,105.560279 Z"
  ],
}
]
}


// -----

var $out = Snap( '#out svg' );
var numOfPath = rhino.shapes.length|0;

var paint = function () {

  // 三角形をクリックすると
  // 該当の三角形に「色」と、「クリックした時点の時間」が記憶される
  // - 色 ( paint.color )
  // - クリックした時点の時間 ( paint.timestamp )
  // をsocketで共有する
  // 色のアニメーションなどはフロントでよしなに捌く

  let order = +this.attr( 'data-order' )|0;
  let paint = {
    color: [ ( Math.random() * 255 )|0, ( Math.random() * 255 )|0, ( Math.random() * 255 )|0 ],
    timestamp: Date.now()
  };

  // 足したのコレだけ
  //rhino.shapes[ order ].paint = paint;
  RhinoPaintoon.paint(order, JSON.stringify(paint));

}

rhino.shapes.forEach( function ( shape, i ) {

  let $path = $out.path();

  $path.attr( {
    d: shape.path[ 0 ],
    fill: shape.fill,
    'data-order': i
  } );

  $path.click( paint );

} );

var $pathSet = $out.selectAll( 'path' );


// 歩くアニメーション
var anim = function ( frame ) {

  let next = frame === rhino.frame - 1 ? 0|0 : ( frame + 1 )|0;

  for ( let i = 0; i < numOfPath; ( i ++ )|0 ) {

    let $el   = $pathSet[ i ];
    let shape = rhino.shapes[ i ];
    let eq    = $el.equal( 'd', shape.path[ frame ] );
    shape.eq  = eq;

  };

  Snap.animate( 0.0, 1.0, function ( progress ) {

    for ( let i = 0; i < numOfPath; ( i ++ )|0 ) {

      let $el   = $pathSet[ i ];
      let shape = rhino.shapes[ i ];

      // フレーム間で、dの値が同じ、つまり変化しない場合は
      // 属性値を変更する前に continue
      if ( shape.eq.from.join( '' ) === shape.eq.to.join( '' ) ) {

        continue;

      }

      let frame = shape.eq.f( getDiff( shape.eq.from, shape.eq.to, progress ) );
      $el.attr( { d: frame } );

    }

  }, 500.0, mina.easein, function () {

    anim( next );

  } );


}

anim( 1 );


var watchFillColor = function () {

  requestAnimationFrame( watchFillColor );

  const EXPIRED  = 3000;
  const DURATION = 1000;

  var now = Date.now();

  for ( let i = 0; i < numOfPath; ( i ++ )|0 ) {

    let $el      = $pathSet[ i ];
    let paint    = rhino.shapes[ i ].paint;
    let progress = 0.0;

    if ( !paint || !paint.color || !paint.timestamp ) {

      continue;

    }

    if ( now < paint.timestamp + EXPIRED ) {

      progress = 0.0;

    } else if ( now < paint.timestamp + EXPIRED + DURATION ) {

      progress = ( now - paint.timestamp + EXPIRED ) / DURATION - 6.0;

    } else {

      progress = 1.0;
      delete rhino.shapes[ i ].paint;

    }

    let fill = hexToRGBArray( rhino.shapes[ i ].fill );
    let fillR = fill[ 0 ] * ( progress );
    let fillG = fill[ 1 ] * ( progress );
    let fillB = fill[ 2 ] * ( progress );
    let paintR = paint.color[ 0 ] * ( 1.0 - progress );
    let paintG = paint.color[ 1 ] * ( 1.0 - progress );
    let paintB = paint.color[ 2 ] * ( 1.0 - progress );
    let r = ( fillR + paintR )|0;
    let g = ( fillG + paintG )|0;
    let b = ( fillB + paintB )|0;

    $el.attr( { fill: 'rgb( ' + r + ',' + g + ',' + b + ')' } );

  }

}

watchFillColor();

function getDiff ( from, to, progress ) {

  var result = [];
  var len = from.length;

  for ( let i = 0; i < len; ( i ++ )|0 ) {

    result.push( from[ i ] + ( to[ i ] - from[ i ] ) * progress );

  }

  return result;

}

function hexToRGBArray ( hex ) {

  let r = parseInt( hex.charAt( 1 ) + hex.charAt( 2 ), 16 )|0;
  let g = parseInt( hex.charAt( 3 ) + hex.charAt( 4 ), 16 )|0;
  let b = parseInt( hex.charAt( 5 ) + hex.charAt( 6 ), 16 )|0;

  return [ r, g, b ];

}

</script>


</body>
</html>
